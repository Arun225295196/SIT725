<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIT725 MVC Project</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .container {
            margin-top: 2rem;
        }

        .card {
            height: 100%;
        }

        .card-image img {
            height: 200px;
            object-fit: cover;
        }

        .card-title {
            background: rgba(0,0,0,0.5);
            padding: 10px !important;
            font-size: 1.2rem !important;
        }

        .chip {
            margin-top: 10px;
        }

        .modal {
            max-height: 90%;
        }

        @media only screen and (max-width: 992px) {
            .container {
                width: 95%;
            }
        }

        .fixed-action-btn {
            position: fixed;
            right: 23px;
            bottom: 23px;
            z-index: 997;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="blue darken-2">
        <div class="nav-wrapper container">
            <a href="#" class="brand-logo">SIT725 MVC</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="#projects">Projects</a></li>
                <li><a href="#" class="waves-effect waves-light btn" onclick="openAddModal()">Add Project</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col s12">
                <h2 class="center-align">My Projects</h2>
                <p class="center-align grey-text">MVC Architecture Implementation</p>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="center-align">
            <div class="preloader-wrapper active">
                <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Grid -->
        <div id="projects-container" class="row" style="display: none;">
            <!-- Projects will be loaded here -->
        </div>
    </div>

    <!-- Floating Action Button for mobile -->
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large blue darken-2" onclick="openAddModal()">
            <i class="large material-icons">add</i>
        </a>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <h4>Add New Project</h4>
            <form id="addProjectForm" onsubmit="event.preventDefault(); addProject();">
                <div class="row">
                    <div class="input-field col s12">
                        <input id="title" name="title" type="text" required>
                        <label for="title">Project Title *</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <textarea id="description" name="description" class="materialize-textarea" required></textarea>
                        <label for="description">Description *</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <select id="category" name="category">
                            <option value="" disabled selected>Choose category</option>
                            <option value="Web Development">Web Development</option>
                            <option value="Mobile App">Mobile App</option>
                            <option value="Data Science">Data Science</option>
                            <option value="Machine Learning">Machine Learning</option>
                            <option value="Other">Other</option>
                        </select>
                        <label>Category</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="image" name="image" type="url">
                        <label for="image">Image URL</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="link" name="link" type="url">
                        <label for="link">Project Link</label>
                    </div>
                </div>
                <p><small>* Required fields</small></p>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
            <button type="button" onclick="addProject()" class="waves-effect waves-green btn blue darken-2">
                <i class="material-icons left">add</i>Add Project
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        // Initialize Materialize components
        document.addEventListener('DOMContentLoaded', function() {
            M.AutoInit();
            loadProjects();
        });

        // API base URL
        const API_BASE = '/api';

        // Load all projects
        async function loadProjects() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('projects-container');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            
            try {
                console.log('Loading projects...');
                const response = await fetch(`${API_BASE}/projects`);
                const result = await response.json();
                
                console.log('Response:', result);
                
                if (result.success) {
                    displayProjects(result.data);
                } else {
                    M.toast({html: 'Error loading projects: ' + result.message, classes: 'red'});
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                M.toast({html: 'Network error loading projects', classes: 'red'});
            } finally {
                loading.style.display = 'none';
                container.style.display = 'block';
            }
        }

        // Display projects in the grid
        function displayProjects(projects) {
            const container = document.getElementById('projects-container');
            container.innerHTML = '';
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="col s12">
                        <div class="card-panel center-align">
                            <h5>No projects yet</h5>
                            <p>Click "Add Project" to create your first project!</p>
                            <button onclick="openAddModal()" class="btn blue darken-2">
                                <i class="material-icons left">add</i>Add Your First Project
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            projects.forEach(project => {
                const projectCard = createProjectCard(project);
                container.innerHTML += projectCard;
            });
        }

        // Create project card HTML
        function createProjectCard(project) {
            return `
                <div class="col s12 m6 l4">
                    <div class="card">
                        <div class="card-image">
                            <img src="${project.image || 'https://via.placeholder.com/300'}" alt="${project.title}" onerror="this.src='https://via.placeholder.com/300'">
                            <span class="card-title">${project.title}</span>
                        </div>
                        <div class="card-content">
                            <p>${project.description}</p>
                            <div class="chip">${project.category || 'Uncategorized'}</div>
                        </div>
                        <div class="card-action">
                            <a href="${project.link || '#'}" target="_blank" class="blue-text">View Project</a>
                            <a href="#" onclick="deleteProject(${project.id})" class="red-text right">Delete</a>
                        </div>
                    </div>
                </div>
            `;
        }

        // Open add project modal
        function openAddModal() {
            console.log('Opening modal...');
            const modalElem = document.getElementById('addProjectModal');
            const modal = M.Modal.getInstance(modalElem);
            
            if (modal) {
                modal.open();
            } else {
                console.error('Modal not initialized');
                M.toast({html: 'Error opening modal', classes: 'red'});
            }
        }

        // Add new project
        async function addProject() {
            console.log('Add project function called');
            
            // Get form values
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const image = document.getElementById('image').value.trim();
            const link = document.getElementById('link').value.trim();
            
            // Basic validation
            if (!title || !description) {
                M.toast({html: 'Title and description are required', classes: 'red'});
                return;
            }
            
            const formData = {
                title: title,
                description: description,
                category: category || 'Uncategorized',
                image: image || 'https://via.placeholder.com/300',
                link: link || '#'
            };
            
            console.log('Form data:', formData);
            
            try {
                const response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    M.toast({html: 'Project added successfully!', classes: 'green'});
                    const modal = M.Modal.getInstance(document.getElementById('addProjectModal'));
                    modal.close();
                    
                    // Reset form
                    document.getElementById('addProjectForm').reset();
                    
                    // Reinitialize select
                    const selectElem = document.getElementById('category');
                    M.FormSelect.init(selectElem);
                    
                    // Update labels
                    M.updateTextFields();
                    
                    // Reload projects
                    loadProjects();
                } else {
                    M.toast({html: result.message || 'Error adding project', classes: 'red'});
                }
            } catch (error) {
                console.error('Error adding project:', error);
                M.toast({html: 'Network error adding project', classes: 'red'});
            }
        }

        // Delete project
        async function deleteProject(id) {
            if (!confirm('Are you sure you want to delete this project?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/projects/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    M.toast({html: 'Project deleted successfully!', classes: 'green'});
                    loadProjects();
                } else {
                    M.toast({html: result.message || 'Error deleting project', classes: 'red'});
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                M.toast({html: 'Network error deleting project', classes: 'red'});
            }
        }
    </script>
</body>
</html>